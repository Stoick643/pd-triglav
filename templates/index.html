{% extends "base.html" %}

{% block title %}Domov - PD Triglav{% endblock %}

{% block content %}
<div class="row">
    <!-- Hero Section -->
    <div class="col-12">
        <div class="jumbotron bg-light p-5 rounded mb-4">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="display-4">Dobrodošli v PD Triglav!</h1>
                    <p class="lead">
                        Planinsko društvo za ljubitelje gora, narave in druženja. 
                        Odkrivajte slovenski gorski svet z nami.
                    </p>
                    {% if not current_user.is_authenticated %}
                    <div class="mt-4">
                        <a href="{{ url_for('auth.register') }}" class="btn btn-primary btn-lg me-3">
                            Pridruži se nam
                        </a>
                        <a href="{{ url_for('auth.login') }}" class="btn btn-outline-primary btn-lg">
                            Prijava
                        </a>
                    </div>
                    {% elif current_user.is_pending() %}
                    <div class="alert alert-warning mt-4">
                        <i class="bi bi-clock"></i>
                        Vaša registracija čaka na odobritev administratorja.
                    </div>
                    {% else %}
                    <div class="mt-4">
                        <a href="{{ url_for('main.dashboard') }}" class="btn btn-primary btn-lg">
                            Pojdi na nadzorno ploščo
                        </a>
                    </div>
                    {% endif %}
                </div>
                <div class="col-md-4 text-center">
                    <i class="bi bi-mountain display-1 text-primary"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Quick Info for Non-Members -->
    {% if not current_user.is_authenticated or current_user.is_pending() %}
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-info-circle text-primary"></i> O društvu
                </h5>
                <p class="card-text">
                    PD Triglav združuje planince iz vse Slovenije. Organiziramo izlete, 
                    tečaje in družabne dogodke.
                </p>
                <a href="{{ url_for('main.about') }}" class="btn btn-outline-primary">Več o nas</a>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-calendar-event text-success"></i> Prihajajoči izleti
                </h5>
                <p class="card-text">
                    Redno organiziramo izlete za različne stopnje pripravljenosti. 
                    Pridruži se nam!
                </p>
                {% if not current_user.is_authenticated %}
                <small class="text-muted">Prijavi se za dostop do programa izletov.</small>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-people text-info"></i> Skupnost
                </h5>
                <p class="card-text">
                    Naša skupnost šteje preko 200 članov. Delimo izkušnje in 
                    fotografije z naših izletov.
                </p>
                {% if not current_user.is_authenticated %}
                <a href="{{ url_for('auth.register') }}" class="btn btn-outline-info">Registriraj se</a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Member Content -->
    {% if current_user.is_authenticated and current_user.can_access_content() %}
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-calendar3"></i> Prihajajoči izleti</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Trenutno ni objavljenih izletov.</p>
                <!-- This will be populated when we implement trips -->
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-chat-dots"></i> Zadnje objave</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Ni novih objav.</p>
                <!-- This will be populated when we implement trip reports -->
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Historical Event Section -->
{% if True %} <!-- Temporarily show to everyone for testing -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history me-2"></i>Na ta dan v zgodovini
                    </h5>
                    <div class="header-controls">
                        {% if current_user.is_authenticated and current_user.is_admin() %}
                        <button id="regenerate-event-btn" class="btn btn-sm btn-outline-light me-2" title="Regeneriraj dogodek">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                        {% endif %}
                        <button id="toggle-history-btn" class="btn btn-sm btn-outline-light" title="Zgodovina dogodkov">
                            <i class="bi bi-archive"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% if todays_event %}
                    <div class="row">
                        <div class="col-md-8">
                            <h6 class="text-primary mb-2">
                                {{ todays_event.full_date_string }}
                                <span class="badge bg-{{ 'success' if todays_event.category.value == 'first_ascent' else 'warning' if todays_event.category.value == 'achievement' else 'info' if todays_event.category.value == 'expedition' else 'secondary' if todays_event.category.value == 'discovery' else 'danger' }} ms-2">
                                    {% if todays_event.category.value == 'first_ascent' %}Prva vzpon
                                    {% elif todays_event.category.value == 'achievement' %}Dosežek
                                    {% elif todays_event.category.value == 'expedition' %}Odprava
                                    {% elif todays_event.category.value == 'discovery' %}Odkritje
                                    {% elif todays_event.category.value == 'tragedy' %}Tragedija
                                    {% else %}Dogodek
                                    {% endif %}
                                </span>
                            </h6>
                            <h5 class="mb-3">{{ todays_event.title }}</h5>
                            <p class="mb-3">{{ todays_event.description }}</p>
                            
                            <div class="d-flex flex-wrap gap-3 text-muted small">
                                {% if todays_event.location %}
                                <div>
                                    <i class="bi bi-geo-alt me-1"></i>
                                    <strong>Lokacija:</strong> {{ todays_event.location }}
                                </div>
                                {% endif %}
                                {% if todays_event.people_names %}
                                <div>
                                    <i class="bi bi-people me-1"></i>
                                    <strong>Udeleženci:</strong> {{ todays_event.people_names }}
                                </div>
                                {% endif %}
                            </div>
                            
                            {% if todays_event.url or todays_event.url_secondary %}
                            <div class="mt-3">
                                {% if todays_event.url %}
                                <a href="{{ todays_event.url }}" target="_blank" class="btn btn-outline-primary btn-sm me-2">
                                    <i class="bi bi-link-45deg me-1"></i>Vir 1
                                </a>
                                {% endif %}
                                {% if todays_event.url_secondary %}
                                <a href="{{ todays_event.url_secondary }}" target="_blank" class="btn btn-outline-secondary btn-sm">
                                    <i class="bi bi-link-45deg me-1"></i>Vir 2
                                </a>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-4 text-center d-flex align-items-center justify-content-center">
                            <div class="text-primary">
                                {% if todays_event.category.value == 'first_ascent' %}
                                    <i class="bi bi-mountain display-3"></i>
                                {% elif todays_event.category.value == 'achievement' %}
                                    <i class="bi bi-trophy display-3"></i>
                                {% elif todays_event.category.value == 'expedition' %}
                                    <i class="bi bi-compass display-3"></i>
                                {% elif todays_event.category.value == 'discovery' %}
                                    <i class="bi bi-search display-3"></i>
                                {% elif todays_event.category.value == 'tragedy' %}
                                    <i class="bi bi-heart display-3"></i>
                                {% else %}
                                    <i class="bi bi-calendar-event display-3"></i>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3 pt-3 border-top">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="bi bi-robot me-1"></i>
                                Vsebina je bila {{ 'avtomatsko generirana' if todays_event.is_generated else 'ročno dodana' }}
                                {{ todays_event.created_at.strftime('%-d. %-m. %Y') if todays_event.created_at else '' }}
                            </small>
                            <a href="#" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-archive me-1"></i>Zgodovina dogodkov
                            </a>
                        </div>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-clock-history display-4 text-muted mb-3"></i>
                        <h6 class="text-muted">Danes ni zgodovinskih dogodkov</h6>
                        <p class="text-muted">
                            Preverite pozneje ali <a href="#" class="text-decoration-none">povejte nam o dogodku</a>, ki ga poznate.
                        </p>
                    </div>
                {% endif %}
            </div>
            
            <!-- History Archive Section (hidden by default) -->
            <div id="history-archive" class="border-top" style="display: none;">
                <div class="p-3">
                    <h6 class="mb-3">
                        <i class="bi bi-archive me-2"></i>Zgodovina dogodkov
                        <span id="history-stats" class="text-muted small ms-2"></span>
                    </h6>
                    
                    <!-- Loading indicator -->
                    <div id="history-loading" class="text-center py-3" style="display: none;">
                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                            <span class="visually-hidden">Nalagam...</span>
                        </div>
                        Nalagam zgodovinske dogodke...
                    </div>
                    
                    <!-- Events list -->
                    <div id="history-events" class="list-group list-group-flush">
                        <!-- Events will be loaded here via AJAX -->
                    </div>
                    
                    <!-- Load more button -->
                    <div id="load-more-container" class="text-center mt-3" style="display: none;">
                        <button id="load-more-btn" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-plus-circle me-1"></i>Naloži več
                        </button>
                    </div>
                    
                    <!-- No events message -->
                    <div id="no-events-message" class="text-center py-3 text-muted" style="display: none;">
                        <i class="bi bi-info-circle me-2"></i>Ni zgodovinskih dogodkov za prikaz.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Historical Events JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    let historyOffset = 0;
    const historyLimit = 7;
    let isLoadingHistory = false;
    let hasMoreHistory = true;

    // Admin regenerate functionality
    const regenerateBtn = document.getElementById('regenerate-event-btn');
    if (regenerateBtn) {
        regenerateBtn.addEventListener('click', function() {
            if (confirm('Ali ste prepričani, da želite regenerirati današnji dogodek?')) {
                regenerateEvent();
            }
        });
    }

    // History toggle functionality
    const toggleHistoryBtn = document.getElementById('toggle-history-btn');
    const historyArchive = document.getElementById('history-archive');
    
    toggleHistoryBtn.addEventListener('click', function() {
        if (historyArchive.style.display === 'none') {
            showHistory();
        } else {
            hideHistory();
        }
    });

    // Load more functionality
    const loadMoreBtn = document.getElementById('load-more-btn');
    loadMoreBtn.addEventListener('click', function() {
        loadHistoryEvents(historyOffset);
    });

    function regenerateEvent() {
        const btn = document.getElementById('regenerate-event-btn');
        const originalIcon = btn.innerHTML;
        
        // Show loading state
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i>';
        
        fetch('/admin/regenerate-today-event', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Refresh the page to show updated event
                location.reload();
            } else {
                alert('Napaka: ' + (data.error || 'Neznana napaka'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Napaka pri regeneraciji dogodka');
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = originalIcon;
        });
    }

    function showHistory() {
        historyArchive.style.display = 'block';
        toggleHistoryBtn.innerHTML = '<i class="bi bi-archive-fill"></i>';
        
        // Load events if not already loaded
        if (historyOffset === 0) {
            loadHistoryEvents(0);
        }
    }

    function hideHistory() {
        historyArchive.style.display = 'none';
        toggleHistoryBtn.innerHTML = '<i class="bi bi-archive"></i>';
    }

    function loadHistoryEvents(offset) {
        if (isLoadingHistory) return;
        
        isLoadingHistory = true;
        const loading = document.getElementById('history-loading');
        const loadMoreContainer = document.getElementById('load-more-container');
        
        loading.style.display = 'block';
        loadMoreContainer.style.display = 'none';
        
        fetch(`/api/history/recent?offset=${offset}&limit=${historyLimit}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayHistoryEvents(data.events, offset === 0);
                    historyOffset = data.loaded;
                    hasMoreHistory = data.has_more;
                    
                    // Update stats
                    const stats = document.getElementById('history-stats');
                    stats.textContent = `(${data.loaded} od ${data.total})`;
                    
                    // Show/hide load more button
                    if (hasMoreHistory) {
                        loadMoreContainer.style.display = 'block';
                    }
                    
                    // Show no events message if no events
                    if (data.events.length === 0 && offset === 0) {
                        document.getElementById('no-events-message').style.display = 'block';
                    }
                } else {
                    alert('Napaka pri nalaganju dogodkov: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Napaka pri nalaganju dogodkov');
            })
            .finally(() => {
                loading.style.display = 'none';
                isLoadingHistory = false;
            });
    }

    function displayHistoryEvents(events, clearExisting) {
        const container = document.getElementById('history-events');
        
        if (clearExisting) {
            container.innerHTML = '';
        }
        
        events.forEach(event => {
            const eventElement = createEventElement(event);
            container.appendChild(eventElement);
        });
    }

    function createEventElement(event) {
        const div = document.createElement('div');
        div.className = 'list-group-item list-group-item-action';
        
        const categoryBadge = getCategoryBadge(event.category);
        const peopleText = event.people.length > 0 ? event.people.join(', ') : '';
        
        div.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center mb-1">
                        <strong class="me-2">${event.full_date_string}</strong>
                        ${categoryBadge}
                    </div>
                    <h6 class="mb-1">${event.title}</h6>
                    <p class="mb-1 text-muted small">${event.description}</p>
                    ${event.location ? `<small class="text-muted"><i class="bi bi-geo-alt me-1"></i>${event.location}</small>` : ''}
                    ${peopleText ? `<small class="text-muted ms-3"><i class="bi bi-people me-1"></i>${peopleText}</small>` : ''}
                </div>
            </div>
        `;
        
        return div;
    }

    function getCategoryBadge(category) {
        const badges = {
            'first_ascent': '<span class="badge bg-success">Prva vzpon</span>',
            'achievement': '<span class="badge bg-warning">Dosežek</span>',
            'expedition': '<span class="badge bg-info">Odprava</span>',
            'discovery': '<span class="badge bg-secondary">Odkritje</span>',
            'tragedy': '<span class="badge bg-danger">Tragedija</span>'
        };
        return badges[category] || '<span class="badge bg-light">Dogodek</span>';
    }

    function getCSRFToken() {
        // Get CSRF token from meta tag if available
        const token = document.querySelector('meta[name="csrf-token"]');
        return token ? token.getAttribute('content') : '';
    }
});

// CSS for spinning animation
const style = document.createElement('style');
style.textContent = `
    .spin {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);
</script>

{% endif %}
{% endblock %}